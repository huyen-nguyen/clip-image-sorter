<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>wasm-vips memory leak debug</title>
    <script src="./vips/vips.js"></script>
  </head>
  <body>
    <button id="startBtn" onclick="start()">click here to start processing</button>
    
    <script>
      let nProcessed = 0;
      
      async function start() {
        if(!window.showDirectoryPicker) return alert("Your browser does not support some modern features (specifically, File System Access API) required to use this web app. Please try updating your browser, or switching to Chrome, Edge, or Brave.");
        
        startBtn.disabled = true;
        
        window.vips = await Vips();
        
        let blob = await fetch("https://i.imgur.com/RKsLoNB.png", {referrer:""}).then(r => r.blob());
        
        let nProcessed = 0;
        for(let i = 0; i < 50000; i++) {
          let resizedBlob = await bicubicResizeAndCenterCrop(blob);
          if(nProcessed++ % 100 === 0) console.log(`${nProcessed} images processed`);
        }
      }
      
      async function bicubicResizeAndCenterCrop(blob) {
        let im1 = vips.Image.newFromBuffer(await blob.arrayBuffer());

        // Resize so smallest side is 224px:
        let resizeFactor = 1;
        if (im1.width > im1.height) {
            resizeFactor = 224 / im1.height;
        } else {
            resizeFactor = 224 / im1.width;
        }

        let im2 = im1.resize(resizeFactor, { kernel: vips.Kernel.cubic });

        // crop to 224x224:
        let left = (im2.width - 224) / 2;
        let top = (im2.height - 224) / 2;
        let im3 = im2.crop(left, top, 224, 224)

        let outBuffer = new Uint8Array(im3.writeToBuffer('.png'));
        im1.delete(), im2.delete(), im3.delete();
        return new Blob([outBuffer], { type: 'image/png' });
      }
    </script>
  </body>
</html>
